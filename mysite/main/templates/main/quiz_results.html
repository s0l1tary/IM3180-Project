{% extends "register/base.html" %}
{% block title %}Results · DeepLearn{% endblock %}

{% block content %}
  {% include "main/navbar.html" %}

  <div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h3 mb-0">Your Results</h1>
      <span class="badge bg-primary">{{ difficulty|title }}</span>
    </div>

    <div class="alert alert-info">
      Score: <strong>{{ score }}</strong> / {{ total }}
    </div>

    {% for r in results %}
      <div class="card mb-3 p-3">
        <h5 class="mb-2">{{ forloop.counter }}. {{ r.question.text }}</h5>
        <ul class="mb-0">
          {% for opt in r.options %}
            <li
              class="{% if opt.id|stringformat:'s' == r.correct_id|stringformat:'s' %}text-success{% endif %}
                     {% if opt.id|stringformat:'s' == r.chosen_id|stringformat:'s' and not r.is_correct %}text-danger{% endif %}">
              {{ opt.text }}
              {% if opt.id|stringformat:'s' == r.correct_id|stringformat:'s' %} ✓ Correct{% endif %}
              {% if opt.id|stringformat:'s' == r.chosen_id|stringformat:'s' and not r.is_correct %} (your answer){% endif %}
            </li>
          {% endfor %}
        </ul>
        <!-- Add "Explain" button -->
        <button 
          class="btn btn-info explain-btn mt-2"
          data-question="{{ r.question.text|escapejs }}"
          data-answer="{% for opt in r.options %}{% if opt.id|stringformat:'s' == r.correct_id|stringformat:'s' %}{{ opt.text|escapejs }}{% endif %}{% endfor %}"
          type="button"
        >
          Explain
        </button>
      </div>
    {% endfor %}

    <div class="d-flex gap-2">
      <a class="btn btn-primary" href="{% url 'quiz' %}?difficulty={{ difficulty }}">Try again</a>
      <a class="btn btn-outline-secondary" href="{% url 'quiz' %}">Change difficulty</a>
    </div>
  </div>

  <!-- Explain Modal -->
  <div class="modal fade" id="explainModal" tabindex="-1" aria-labelledby="explainModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="explainModalLabel">Explanation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="explain-content">
          Loading...
        </div>
      </div>
    </div>
  </div>

  <script>
    // CSRF token helper function
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    document.addEventListener('DOMContentLoaded', function () {
      document.querySelectorAll('.explain-btn').forEach(function (button) {
        button.addEventListener('click', function () {
          var question = button.getAttribute('data-question');
          var answer = button.getAttribute('data-answer');
          var modal = new bootstrap.Modal(document.getElementById('explainModal'));
          var modalContent = document.getElementById('explain-content');
          modalContent.innerHTML = "Loading...";
          fetch("{% url 'explain' %}", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRFToken": csrftoken
            },
            body: "question=" + encodeURIComponent(question) + "&answer=" + encodeURIComponent(answer)
          })
          .then(response => response.json())
          .then(data => {
            modalContent.innerHTML = data.explanation || data.error || "No explanation returned.";
            if (window.MathJax) { MathJax.typesetPromise([modalContent]); }
          })
          .catch(error => {
            modalContent.innerHTML = "Error: " + error;
          });
          modal.show();
        });
      });
    });
  </script>
{% endblock %}
